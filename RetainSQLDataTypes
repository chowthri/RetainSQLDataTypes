using System;
using System.Data.SqlTypes;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
//v2
public class PreserveAllSqlServerDataTypesConverter : JsonConverter
{
    public override bool CanConvert(Type objectType)
    {
        // Check if the type is derived from SqlType or if it is a nullable type
        return typeof(SqlType).IsAssignableFrom(objectType) || (Nullable.GetUnderlyingType(objectType) != null && typeof(SqlType).IsAssignableFrom(Nullable.GetUnderlyingType(objectType)));
    }

    public override object ReadJson(JsonReader reader, Type objectType, object existingValue, JsonSerializer serializer)
    {
        if (reader.TokenType == JsonToken.Null)
        {
            // Handle null values
            return null;
        }

        JToken token = JToken.Load(reader);

        if (typeof(SqlType).IsAssignableFrom(objectType))
        {
            // For SqlType or derived types, directly deserialize to the specified type
            return token.ToObject(objectType);
        }
        else if (Nullable.GetUnderlyingType(objectType) != null && typeof(SqlType).IsAssignableFrom(Nullable.GetUnderlyingType(objectType)))
        {
            // For nullable types of SqlType, get the underlying type and deserialize
            var underlyingType = Nullable.GetUnderlyingType(objectType);
            return token.ToObject(underlyingType);
        }

        throw new InvalidOperationException($"Unexpected object type: {objectType}");
    }

    public override void WriteJson(JsonWriter writer, object value, JsonSerializer serializer)
    {
        if (value == null)
        {
            // Write null values
            writer.WriteNull();
            return;
        }

        JToken.FromObject(value).WriteTo(writer);
    }
}


var settings = new JsonSerializerSettings
{
    Converters = { new PreserveAllSqlServerDataTypesConverter() },
};

string json = JsonConvert.SerializeObject(yourObject, settings);

